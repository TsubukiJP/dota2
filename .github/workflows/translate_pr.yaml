name: Translate Dota 2 Localization

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Fetch localization data with SteamCMD"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: translate-localization
  cancel-in-progress: false

jobs:
  translate:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # workflow_run の場合はそのトリガーとなったコミット (head_sha)
          # workflow_dispatch の場合はデフォルト (github.sha/ref) になるようフォールバック... 
          # だが empty string だと checkout v4 は default behavior (correct ref) をとる特性を利用できるか？
          # 安全策: workflow_run.head_sha があればそれ、なければ github.sha
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 2  # changed判定(HEAD~1)のため

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r scripts/python/requirements.txt

      - name: Run translation script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python scripts/python/translate.py --mode missing+changed

      - name: Build artifact
        run: |
          python scripts/python/build.py

      - name: Upload artifact
        if: ${{ always() && hashFiles('dota2jp.zip') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: dota2jp-translation
          path: |
            dota2jp.zip
            unprocessed_keys.log

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated translation update"
          title: "Automated Translation Update"
          body: |
            This PR contains automated translations generated by Gemini AI.

            Included files:
            - main/resource/localization/*_japanese.txt.json

            Please review the changes.
          branch: automated-translations
          delete-branch: true
          base: master
          labels: "automated-translation"
          add-paths: |
            main/resource/localization/*_japanese.txt.json
            docs/glossary.csv
            docs/ai_rules.md
